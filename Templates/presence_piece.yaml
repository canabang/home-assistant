# Capteur de Présence "Pro" (Phase 2)
# Ce capteur identifie la pièce occupée à partir d'une liste de détecteurs.

- sensor:
    - name: "Presence Piece"
      unique_id: presence_piece
      state: >
        {# CONFIGURATION : Listez vos capteurs par pièce ici #}
        {% set presence_map = {
          'Salon': ['binary_sensor.salon_presence_globale'],
          'Cuisine': ['binary_sensor.esp_cuisine_presence'],
          'Chambre': ['binary_sensor.esp_chambre_presence'],
          'SdB': ['binary_sensor.esp_sdb_presence']
        } %}

        {# 1. CALCUL DES PIÈCES OCCUPÉES #}
        {% set ns = namespace(pieces_occupees=[]) %}
        {% for piece, capteurs in presence_map.items() %}
          {% for capteur in capteurs %}
            {% if is_state(capteur, 'on') %}
              {% set ns.pieces_occupees = ns.pieces_occupees + [piece] %}
              {% break %}
            {% endif %}
          {% endfor %}
        {% endfor %}

        {# 2. GESTION DES PRIORITÉS ET EXCLUSIONS #}
        {% if ns.pieces_occupees | length == 0 %}
          {# Personne n'est détecté #}
        {% elif ns.pieces_occupees | length == 1 %}
          {# Une seule pièce : choix automatique #}
          {{ ns.pieces_occupees[0] }}
        {% elif ns.pieces_occupees | length > 1 %}
          {# Conflit : exclusion intelligente (ex: SdB si fenêtre ouverte ou prismal ON) #}
          {% if 'SdB' in ns.pieces_occupees and (is_state('binary_sensor.ouvfenetsdb_contact', 'on') or is_state('switch.prismal', 'on')) %}
            {% set pieces_candidates = ns.pieces_occupees | reject('eq', 'SdB') | list %}
          {% else %}
            {% set pieces_candidates = ns.pieces_occupees %}
          {% endif %}
          
          {# Ordre de priorité manuel : Salon > Cuisine > Chambre > SdB #}
          {% if 'Salon' in pieces_candidates %} Salon
          {% elif 'Cuisine' in pieces_candidates %} Cuisine
          {% elif 'Chambre' in pieces_candidates %} Chambre
          {% elif 'SdB' in pieces_candidates %} SdB
          {% else %} {{ ns.pieces_occupees[0] }}
          {% endif %}
        {% endif %}
      
      attributes:
        # Attribut utilisé pour savoir sur quel Echo faire le feedback vocal
        echo: >
          {% set echo_map = {
            'Salon': 'media_player.echo_studio_d',
            'Cuisine': 'media_player.echo_show_cuisine',
            'Chambre': 'media_player.echo_show_chambre',
            'SdB': 'media_player.echo_sdb'
          } %}
          {{ echo_map.get(states('sensor.presence_piece'), 'media_player.echo_dot_gael') }}
