# ==========================================================
# CAPTEUR DE PRÉSENCE "PRO" (DÉTECTION DE PIÈCE)
# ==========================================================
# Ce capteur est le cerveau qui permet aux commandes "Lumos" d'être génériques.
# Il fusionne plusieurs capteurs pour déterminer dans quelle pièce vous êtes.
# ==========================================================

- sensor:
    - name: "Presence Piece"
      unique_id: presence_piece
      state: >
        {# ÉTAPE 1 : CONFIGURATION #}
        {# On définit ici quels capteurs physiques appartiennent à quelle pièce #}
        {% set presence_map = {
          'Salon': ['binary_sensor.salon_presence_globale'],
          'Cuisine': ['binary_sensor.esp_cuisine_presence'],
          'Chambre': ['binary_sensor.esp_chambre_presence'],
          'SdB': ['binary_sensor.esp_sdb_presence']
        } %}

        {# ÉTAPE 2 : CALCUL DES PIÈCES OCCUPÉES #}
        {# On utilise un 'namespace' pour pouvoir modifier une variable à l'intérieur d'une boucle #}
        {% set ns = namespace(pieces_occupees=[]) %}
        {% for piece, capteurs in presence_map.items() %}
          {% for capteur in capteurs %}
            {# Si un capteur de la pièce est 'on', on ajoute la pièce à la liste des pièces occupées #}
            {% if is_state(capteur, 'on') %}
              {% set ns.pieces_occupees = ns.pieces_occupees + [piece] %}
              {% break %} {# Pas besoin de vérifier les autres capteurs de cette pièce #}
            {% endif %}
          {% endfor %}
        {% endfor %}

        {# ÉTAPE 3 : GESTION DES CONFLITS ET PRIORITÉS #}
        {% if ns.pieces_occupees | length == 0 %}
          {# Cas 0 : Personne n'est détecté nulle part #}
          Inconnu
        {% elif ns.pieces_occupees | length == 1 %}
          {# Cas 1 : Une seule pièce détectée, c'est facile ! #}
          {{ ns.pieces_occupees[0] }}
        {% elif ns.pieces_occupees | length > 1 %}
          {# Cas 2 : Plusieurs pièces détectées. On applique notre intelligence. #}
          
          {# LOGIQUE D'EXCLUSION : Si on détecte la Salle de Bain mais qu'on y a oublié #}
          {# la lumière ou la fenêtre, on l'ignore pour privilégier les autres pièces. #}
          {% if 'SdB' in ns.pieces_occupees and (is_state('binary_sensor.ouvfenetsdb_contact', 'on') or is_state('switch.prismal', 'on')) %}
            {% set pieces_candidates = ns.pieces_occupees | reject('eq', 'SdB') | list %}
          {% else %}
            {% set pieces_candidates = ns.pieces_occupees %}
          {% endif %}
          
          {# LOGIQUE DE PRIORITÉ : Si on est entre deux pièces, on définit un ordre logique #}
          {# Salon > Cuisine > Chambre > SdB #}
          {% if 'Salon' in pieces_candidates %} Salon
          {% elif 'Cuisine' in pieces_candidates %} Cuisine
          {% elif 'Chambre' in pieces_candidates %} Chambre
          {% elif 'SdB' in pieces_candidates %} SdB
          {% else %} {{ ns.pieces_occupees[0] }}
          {% endif %}
        {% endif %}
      
      attributes:
        # LOGIQUE D'ATTRIBUT : On définit quel Amazon Echo doit répondre 
        # en fonction de l'état actuel du capteur (où se trouve la personne).
        echo: >
          {% set echo_map = {
            'Salon': 'media_player.echo_studio_d',
            'Cuisine': 'media_player.echo_show_cuisine',
            'Chambre': 'media_player.echo_show_chambre',
            'SdB': 'media_player.echo_sdb'
          } %}
          {{ echo_map.get(states('sensor.presence_piece'), 'media_player.echo_dot_gael') }}
