alias: Pet Feeder - DÃ©tection rechargement et reset
description: DÃ©tecte le rechargement (passage de <300g Ã  >950g) et remet le compteur Ã  zÃ©ro
triggers:
  - entity_id:
      - input_number.pet_feeder_stock_estime
    trigger: state
    from: null
    to: null
conditions:
  - condition: template
    value_template: |
      {{ trigger.from_state.state | float(0) < 300 and 
         trigger.to_state.state | float(0) > 950 }}
actions:
  - target:
      entity_id: input_number.pet_feeder_daily_consumption_counter
    data:
      value: 0
    action: input_number.set_value
  - target:
      entity_id: input_boolean.pet_feeder_stock_was_low
    action: input_boolean.turn_off
    data: {}
  - target:
      entity_id: input_number.pet_feeder_cumulative_distributed_since_refill
    data:
      value: 0
    action: input_number.set_value
  - target:
      entity_id: input_number.pet_feeder_refill_date
    data:
      value: "{{ now().timestamp() }}"
    action: input_number.set_value
  - action: system_log.write
    data:
      message: >
        Pet Feeder: RECHARGEMENT DÃ‰TECTÃ‰! Reset compteurs.  Stock: {{
        trigger.from_state.state }}g â†’ {{ trigger.to_state.state }}g.  Nouveau
        cycle de suivi dÃ©marrÃ©.
      level: info


alias: Pet Feeder - Initialisation manuelle remplissage
description: Permet d'initialiser manuellement un nouveau cycle de suivi
triggers:
  - entity_id: input_boolean.pet_feeder_manual_refill_trigger
    trigger: state
    to: "on"
actions:
  - target:
      entity_id: input_number.pet_feeder_cumulative_distributed_since_refill
    data:
      value: 0
    action: input_number.set_value
  - target:
      entity_id: input_number.pet_feeder_refill_date
    data:
      value: "{{ now().timestamp() }}"
    action: input_number.set_value
  - target:
      entity_id: input_number.pet_feeder_daily_consumption_counter
    data:
      value: 0
    action: input_number.set_value
  - target:
      entity_id: input_boolean.pet_feeder_manual_refill_trigger
    action: input_boolean.turn_off
    data: {}
  - action: system_log.write
    data:
      message: "Pet Feeder: Initialisation manuelle d'un nouveau cycle de suivi"
      level: info
mode: single


alias: Pet Feeder - Mise Ã  jour compteurs unifiÃ©e
description: >-
  Met Ã  jour tous les compteurs (quotidien, cumulatif, stock) lors d'une
  distribution
triggers:
  - entity_id:
      - sensor.pet_feeder_weight_per_day
    trigger: state
    from: null
    to: null
conditions:
  - condition: template
    value_template: |
      {{ trigger.from_state is not none and 
         trigger.to_state is not none and
         trigger.from_state.state not in ['unknown', 'unavailable'] and
         trigger.to_state.state not in ['unknown', 'unavailable'] and
         trigger.to_state.state | float(0) > 0 and
         trigger.to_state.state | float(0) > trigger.from_state.state | float(0) and
         (trigger.to_state.state | float(0) - trigger.from_state.state | float(0)) > 0.5 }}
actions:
  - variables:
      poids_distribue: "{{ (trigger.to_state.state | float(0) - trigger.from_state.state | float(0)) | round(1) }}"
      stock_actuel: "{{ states('input_number.pet_feeder_stock_estime') | float(0) }}"
      nouveau_stock: "{{ [stock_actuel - poids_distribue, 0] | max | round(1) }}"
      cumul_actuel: >-
        {{ states('input_number.pet_feeder_cumulative_distributed_since_refill')
        | float(0) }}
      nouveau_cumul: "{{ (cumul_actuel + poids_distribue) | round(1) }}"
      compteur_quotidien_actuel: >-
        {{ states('input_number.pet_feeder_daily_consumption_counter') |
        float(0) }}
      nouveau_compteur_quotidien: "{{ (compteur_quotidien_actuel + poids_distribue) | round(1) }}"
      total_cumulatif_actuel: "{{ states('input_number.pet_feeder_total_distributed') | float(0) }}"
      nouveau_total_cumulatif: "{{ (total_cumulatif_actuel + poids_distribue) | round(1) }}"
  - data:
      entity_id: input_number.pet_feeder_stock_estime
      value: "{{ nouveau_stock }}"
    action: input_number.set_value
  - data:
      entity_id: input_number.pet_feeder_cumulative_distributed_since_refill
      value: "{{ nouveau_cumul }}"
    action: input_number.set_value
  - data:
      entity_id: input_number.pet_feeder_daily_consumption_counter
      value: "{{ nouveau_compteur_quotidien }}"
    action: input_number.set_value
  - data:
      entity_id: input_number.pet_feeder_total_distributed
      value: "{{ nouveau_total_cumulatif }}"
    action: input_number.set_value
  - action: system_log.write
    data:
      message: >
        Pet Feeder: {{ poids_distribue }}g distribuÃ©s ({{ trigger.from_state.state }}g â†’ {{ trigger.to_state.state }}g).  
        Stock: {{ stock_actuel }}g â†’ {{ nouveau_stock }}g |  
        Cumul depuis refill: {{ cumul_actuel }}g â†’ {{ nouveau_cumul }}g |  
        Quotidien: {{ compteur_quotidien_actuel }}g â†’ {{ nouveau_compteur_quotidien }}g |  
        Total: {{ total_cumulatif_actuel }}g â†’ {{ nouveau_total_cumulatif }}g
      level: info
mode: single

alias: Pet Feeder - Recalcul automatique des portions
description: Recalcule et applique les portions quand le poids unitaire change
triggers:
  - entity_id:
      - number.pet_feeder_portion_weight
      - input_number.pet_feeder_target_daily_weight
    trigger: state
    for:
      seconds: 3
    from: null
    to: null
conditions:
  - condition: template
    value_template: |
      {{ trigger.from_state is not none and 
         trigger.to_state is not none and
         trigger.to_state.state not in ['unknown', 'unavailable'] and
         trigger.to_state.state | float(0) > 0 }}
actions:
  - delay:
      seconds: 2
  - variables:
      portions_matin: "{{ states('sensor.portions_calculees_matin') | int(8) }}"
      portions_midi: "{{ states('sensor.portions_calculees_midi') | int(9) }}"
      portions_soir: "{{ states('sensor.portions_calculees_soir') | int(12) }}"
      poids_portion: "{{ trigger.to_state.state | float(3) }}"
  - action: mqtt.publish
    data:
      topic: zigbee2mqtt02/Pet feeder/set
      payload: |
        {
          "schedule": [
            {"days": "everyday", "hour": 8, "minute": 0, "size": {{ portions_matin }}},
            {"days": "everyday", "hour": 14, "minute": 0, "size": {{ portions_midi }}},
            {"days": "everyday", "hour": 20, "minute": 0, "size": {{ portions_soir }}}
          ]
        }
  - action: system_log.write
    data:
      message: >
        Pet Feeder: Portions recalculÃ©es pour {{ poids_portion }}g/portion.
        Nouvelle rÃ©partition: Matin={{ portions_matin }}p, Midi={{ portions_midi
        }}p, Soir={{ portions_soir }}p. Total thÃ©orique: {{ (portions_matin +
        portions_midi + portions_soir) * poids_portion }}g/jour
      level: info
mode: single


alias: Pet Feeder - Reset quotidien compteur consommation
description: Remet Ã  zÃ©ro le compteur de consommation quotidienne chaque jour Ã  minuit
triggers:
  - at: "00:00:00"
    trigger: time
conditions: []
actions:
  - action: input_number.set_value
    target:
      entity_id: input_number.pet_feeder_daily_consumption_counter
    data:
      value: 0
  - action: system_log.write
    data:
      message: "Pet Feeder: Reset automatique du compteur quotidien Ã  minuit"
      level: info
mode: single


alias: Pet Feeder - Suivi stock bas
description: Marque quand le stock passe en dessous de 300g
triggers:
  - entity_id: input_number.pet_feeder_stock_estime
    below: 300
    trigger: numeric_state
actions:
  - target:
      entity_id: input_boolean.pet_feeder_stock_was_low
    action: input_boolean.turn_on
    data: {}



alias: Niveau Fontaine
description: ""
triggers:
  - trigger: numeric_state
    entity_id:
      - sensor.esp_pet_scales_eau
    below: 30
    enabled: false
  - trigger: state
    entity_id:
      - sensor.esp_pet_scales_eau
  - trigger: homeassistant
    event: start
conditions: []
actions:
  - repeat:
      sequence:
        - sequence:
            - action: google_generative_ai_conversation.generate_content
              data:
                prompt: >-
                  GÃ©nÃ¨re un message vocal dâ€™alerte pour prÃ©venir que le niveau
                  dâ€™eau de la fontaine du chat est trop bas.


                  Le ton doit Ãªtre factuel avec une lÃ©gÃ¨re touche dâ€™humour ou de
                  sarcasme faÃ§on droÃ¯de reprogrammÃ© type K-2SO (Star Wars).

                  Le message doit inclure le niveau actuel dâ€™eau, sous forme de
                  pourcentage, fourni dans la variable suivante :

                  {{ states('sensor.esp_pet_scales_eau') }}%

                  Sois bref et direct : la rÃ©ponse doit Ãªtre courte et adaptÃ©e
                  au TTS.

                  Pas de smileys, pas dâ€™Ã©moticÃ´nes, pas de menace ni de formule
                  agressive.

                  Tu peux glisser un clin d'Å“il geek ou pop culture si
                  pertinent.


                  Exemples de ton attendu :


                  Â« Niveau dâ€™eau de la fontaine :
                  {{states('sensor.esp_pet_scales_eau')}} %. Il serait peut-Ãªtre
                  temps dâ€™agir. Â»


                  Â« La fontaine du chat affiche
                  {{states('sensor.esp_pet_scales_eau')}} %. On frÃ´le la panne
                  hydraulique fÃ©line. Â»


                  Â« Niveau critique dÃ©tectÃ© :
                  {{states('sensor.esp_pet_scales_eau')}} %. Je conseille un
                  ravitaillement immÃ©diat. Â»


                  Â« {{states('sensor.esp_pet_scales_eau')}} % dâ€™eau restante.
                  MÃªme un Jawa ne sâ€™en contenterait pas. Â»


                  GÃ©nÃ¨re uniquement la phrase finale, sans balises, sans
                  explications, sans mÃ©tadonnÃ©es.
              response_variable: generated_message
            - action: script.1717220445110
              data:
                message: "{{ generated_message.text }}"
              enabled: true
            - action: script.awtrix_dynamique_customapp_dupliquer
              data:
                icone: fontaine
                rainbow: "false"
                scrollspeed: "50"
                color: "#8b0000"
                duree: "25"
                message: "{{ generated_message.text }}"
        - delay:
            hours: 2
            minutes: 0
            seconds: 0
            milliseconds: 0
      while:
        - condition: numeric_state
          entity_id: sensor.esp_pet_scales_eau
          below: 30
mode: single

alias: "Pet Feeder - Correction Manuelle via Balance"
  description: "Force la synchronisation avec la balance quand demandÃ© manuellement"
  triggers:
    - platform: state
      entity_id: input_boolean.pet_feeder_force_sync_balance
      to: "on"
  actions:
    - variables:
        ancien_stock: "{{ states('input_number.pet_feeder_stock_estime') | float(0) }}"
        nouveau_stock: "{{ states('sensor.balance_croquettes_en_grammes') | float(0) }}"
        ecart_correction: "{{ (nouveau_stock - ancien_stock) | abs }}"
    - service: input_number.set_value
      target:
        entity_id: input_number.pet_feeder_stock_estime
      data:
        value: "{{ nouveau_stock }}"
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.pet_feeder_force_sync_balance
    - service: persistent_notification.dismiss
      data:
        notification_id: "pet_feeder_divergence"
    - service: script.1717220445110
      data:
        message: >
          Correction manuelle effectuÃ©e. Stock corrigÃ© de {{ ancien_stock | round(0) }}g 
          vers {{ nouveau_stock | round(0) }}g selon la balance physique.
    - service: system_log.write
      data:
        message: >
          Pet Feeder: Correction manuelle forcÃ©e par utilisateur.
          Ancien: {{ ancien_stock }}g â†’ Nouveau: {{ nouveau_stock }}g (Ã©cart: {{ ecart_correction }}g)
          Balance: {{ states('sensor.esp_pet_scales_croquettes') }}%
        level: info
  mode: single

  alias: Pet Feeder - Correction Divergence Majeure
description: Correction automatique en cas de divergence importante dÃ©tectÃ©e
triggers:
  - entity_id: sensor.validation_stock_multi_sources
    to: DIVERGENCE_MAJEURE
    for:
      minutes: 2
    trigger: state
conditions:
  - condition: state
    entity_id: sensor.esp_pet_scales_croquettes_etat_capteur_code
    state: "2.0"
  - condition: numeric_state
    entity_id: sensor.esp_pet_scales_croquettes
    above: 5
actions:
  - variables:
      ancien_stock: "{{ states('input_number.pet_feeder_stock_estime') | float(0) }}"
      stock_balance: "{{ states('sensor.balance_croquettes_en_grammes') | float(0) }}"
      ecart_detecte: >-
        {{ state_attr('sensor.validation_stock_multi_sources', 'ecart_absolu')
        }}
  - data:
      notification_id: pet_feeder_divergence
      title: ğŸ¾ Pet Feeder - Divergence DÃ©tectÃ©e
      message: >
        DIVERGENCE MAJEURE dÃ©tectÃ©e !

        ğŸ“Š Balance physique : {{ states('sensor.esp_pet_scales_croquettes') }}%
        ({{ stock_balance }}g) ğŸ§® Estimation HA : {{
        states('sensor.pourcentage_croquette_restant') }}% ({{ ancien_stock }}g)
        âš ï¸ Ã‰cart : {{ ecart_detecte }}

        La balance indique {{ stock_balance }}g, faut-il corriger l'estimation ?

        Cliquez sur 'Corriger avec Balance' pour synchroniser automatiquement.
    action: persistent_notification.create
  - data:
      message: >
        Pet Feeder: DIVERGENCE MAJEURE dÃ©tectÃ©e ! Balance: {{
        states('sensor.esp_pet_scales_croquettes') }}% ({{ stock_balance }}g)
        Estimation: {{ ancien_stock }}g Ã‰cart: {{ ecart_detecte }} Ã‰tat capteur:
        {{ states('sensor.esp_pet_scales_croquettes_etat_capteur') }}
        Notification crÃ©Ã©e pour validation manuelle.
      level: warning
    action: system_log.write
mode: single

alias: Pet Feeder - Niveau Croquettes Multi-Sources Enhanced
description: Alerte intelligente basÃ©e sur balance ET estimation avec validation croisÃ©e
triggers:
  - entity_id: sensor.esp_pet_scales_croquettes
    below: 30
    trigger: numeric_state
  - entity_id: sensor.pourcentage_croquette_restant
    below: 30
    trigger: numeric_state
  - entity_id: sensor.validation_stock_multi_sources
    to: DIVERGENCE_MAJEURE
    trigger: state
  - event: start
    trigger: homeassistant
conditions:
  - condition: or
    conditions:
      - condition: numeric_state
        entity_id: sensor.esp_pet_scales_croquettes
        below: 30
      - condition: numeric_state
        entity_id: sensor.pourcentage_croquette_restant
        below: 30
      - condition: state
        entity_id: sensor.validation_stock_multi_sources
        state: DIVERGENCE_MAJEURE
actions:
  - choose:
      - conditions:
          - condition: state
            entity_id: sensor.validation_stock_multi_sources
            state: DIVERGENCE_MAJEURE
        sequence:
          - data:
              prompt: >
                GÃ©nÃ¨re un message d'alerte technique indiquant une DIVERGENCE
                MAJEURE  entre les mesures de stock de croquettes. Situation
                critique Ã  analyser.

                ğŸ“Š Balance physique : {{
                states('sensor.esp_pet_scales_croquettes') }}% ğŸ§® Estimation
                Home Assistant : {{
                states('sensor.pourcentage_croquette_restant') }}% âš ï¸ Ã‰cart
                dÃ©tectÃ© : {{ state_attr('sensor.validation_stock_multi_sources',
                'ecart_absolu') }} ğŸ”§ Ã‰tat capteur : {{
                states('sensor.esp_pet_scales_croquettes_etat_capteur') }}

                Utilise un ton faÃ§on K-2SO (Star Wars) : factuel, lÃ©gÃ¨rement
                sarcastique,  mais indiquant la gravitÃ© de la situation. Sois
                bref pour le TTS. SuggÃ¨re une vÃ©rification manuelle.
            response_variable: divergence_message
            action: google_generative_ai_conversation.generate_content
          - data:
              message: "{{ divergence_message.text }}"
            action: script.1717220445110
          - data:
              icone: catfood
              rainbow: "true"
              scrollspeed: "40"
              color: "#ff0000"
              duree: "30"
              message: "DIVERGENCE: {{ divergence_message.text[:50] }}..."
            action: script.awtrix_dynamique_customapp_dupliquer
    default:
      - repeat:
          sequence:
            - variables:
                balance_niveau: "{{ states('sensor.esp_pet_scales_croquettes') | float(0) }}"
                estimation_niveau: >-
                  {{ states('sensor.pourcentage_croquette_restant') | float(0)
                  }}
                jours_restants_classique: "{{ states('sensor.jours_restants_nourriture') }}"
                jours_restants_precis: >-
                  {{
                  states('sensor.jours_restants_nourriture_methode_cumulative')
                  }}
                validation_etat: "{{ states('sensor.validation_stock_multi_sources') }}"
            - data:
                prompt: >
                  GÃ©nÃ¨re un message d'alerte pour stock bas de croquettes avec
                  donnÃ©es complÃ¨tes.

                  ğŸ“Š Balance physique : {{ balance_niveau }}% ğŸ§® Estimation HA :
                  {{ estimation_niveau }}% ğŸ“… Autonomie classique : {{
                  jours_restants_classique }} jours ğŸ¯ Autonomie prÃ©cise : {{
                  jours_restants_precis }} jours   ğŸ” Validation : {{
                  validation_etat }}

                  Style K-2SO de Star Wars : factuel avec pointe
                  d'humour/sarcasme. Mentionne la source la plus fiable selon la
                  validation. Message bref pour TTS, max 2 phrases.

                  Si validation = "COHERENT" : utilise les deux valeurs Si
                  validation = "ATTENTION" : privilÃ©gie la balance Sinon :
                  indique l'incertitude
              response_variable: generated_message
              action: google_generative_ai_conversation.generate_content
            - data:
                message: "{{ generated_message.text }}"
              action: script.1717220445110
            - data:
                icone: catfood
                rainbow: "false"
                scrollspeed: "50"
                color: |
                  {% if balance_niveau < 15 or estimation_niveau < 15 %}
                    "#ff0000"
                  {% elif balance_niveau < 25 or estimation_niveau < 25 %}
                    "#ff8000"
                  {% else %}
                    "#ffff00"
                  {% endif %}
                duree: "25"
                message: "{{ generated_message.text }}"
              action: script.awtrix_dynamique_customapp_dupliquer
            - delay:
                hours: 2
          while:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.esp_pet_scales_croquettes
                  below: 30
                - condition: numeric_state
                  entity_id: sensor.pourcentage_croquette_restant
                  below: 30
mode: single

alias: Pet Feeder - Sync Balance vers Estimation
description: Synchronise l'estimation avec la balance si les donnÃ©es sont cohÃ©rentes
triggers:
  - at: "06:00:00"
    trigger: time
  - entity_id: sensor.validation_stock_multi_sources
    to: COHERENT
    for:
      minutes: 5
    trigger: state
conditions:
  - condition: state
    entity_id: sensor.validation_stock_multi_sources
    state: COHERENT
  - condition: numeric_state
    entity_id: sensor.esp_pet_scales_croquettes
    above: 10
  - condition: state
    entity_id: sensor.esp_pet_scales_croquettes_etat_capteur_code
    state: "2.0"
actions:
  - variables:
      ancien_stock: "{{ states('input_number.pet_feeder_stock_estime') | float(0) }}"
      nouveau_stock: "{{ states('sensor.balance_croquettes_en_grammes') | float(0) }}"
      ecart_sync: "{{ (nouveau_stock - ancien_stock) | abs }}"
  - target:
      entity_id: input_number.pet_feeder_stock_estime
    data:
      value: "{{ nouveau_stock }}"
    action: input_number.set_value
  - data:
      message: >
        Pet Feeder: Sync automatique balance â†’ estimation rÃ©ussie. Balance: {{
        states('sensor.esp_pet_scales_croquettes') }}% ({{ nouveau_stock }}g)
        Ancien estimÃ©: {{ ancien_stock }}g â†’ Nouveau: {{ nouveau_stock }}g Ã‰cart
        corrigÃ©: {{ ecart_sync }}g
      level: info
    action: system_log.write
  - if:
      - condition: template
        value_template: "{{ ecart_sync > 100 }}"
    then:
      - data:
          message: >
            Correction automatique du stock : Ã©cart de {{ ecart_sync | round(0)
            }}g  dÃ©tectÃ© et corrigÃ© via la balance physique.
        action: script.1717220445110
mode: single

alias: "Pet Water - Sauvegarde Niveau Matinal"
description: "Enregistre le niveau d'eau du matin pour calculer la consommation"
triggers:
  - platform: time
    at: "06:00:00"
actions:
  - service: input_number.set_value
    target:
      entity_id: input_number.pet_water_level_morning
    data:
      value: "{{ states('sensor.esp_pet_scales_eau') | float(0) }}"
  - service: system_log.write
    data:
      message: >
        Pet Water: Niveau matinal enregistrÃ©: {{ states('sensor.esp_pet_scales_eau') }}%
      level: info
mode: single

# Mise Ã  jour compteur consommation eau
alias: "Pet Water - Mise Ã  Jour Consommation"
description: "Met Ã  jour le compteur de consommation d'eau"
triggers:
  - platform: state
    entity_id: sensor.consommation_eau_quotidienne
  - platform: time
    at: "12:00:00"  # Mise Ã  jour midi
  - platform: time
    at: "18:00:00"  # Mise Ã  jour soir
actions:
  - service: input_number.set_value
    target:
      entity_id: input_number.pet_water_daily_counter
    data:
      value: "{{ states('sensor.consommation_eau_quotidienne') | float(0) }}"
mode: single

# Reset quotidien compteur eau
alias: "Pet Water - Reset Quotidien"
description: "Remet Ã  zÃ©ro le compteur d'eau quotidien"
triggers:
  - platform: time
    at: "00:00:05"
actions:
  - service: input_number.set_value
    target:
      entity_id: input_number.pet_water_daily_counter
    data:
      value: 0
  - service: system_log.write
    data:
      message: "Pet Water: Reset quotidien compteur eau"
      level: info
mode: single

# AmÃ©lioration de votre automation fontaine existante
alias: "Pet Water - Niveau Fontaine Enhanced"
description: "Version enrichie de votre alerte niveau eau avec donnÃ©es complÃ¨tes"
triggers:
  - platform: numeric_state
    entity_id: sensor.esp_pet_scales_eau
    below: 30
  - platform: state
    entity_id: sensor.validation_systeme_complet
    to: "EAU_CRITIQUE"
  - platform: homeassistant
    event: start
conditions:
  - condition: or
    conditions:
      - condition: numeric_state
        entity_id: sensor.esp_pet_scales_eau
        below: 30
      - condition: state
        entity_id: sensor.validation_systeme_complet
        state: "EAU_CRITIQUE"
actions:
  - repeat:
      sequence:
        - variables:
            niveau_eau: "{{ states('sensor.esp_pet_scales_eau') | float(0) }}"
            consommation_jour: "{{ states('sensor.consommation_eau_quotidienne') | float(0) }}"
            ratio_hydratation: "{{ states('sensor.ratio_hydratation_quotidien') | float(0) }}"
            evaluation_hydratation: "{{ state_attr('sensor.ratio_hydratation_quotidien', 'evaluation') }}"
        - service: google_generative_ai_conversation.generate_content
          data:
            prompt: >
              GÃ©nÃ¨re un message d'alerte pour niveau d'eau bas de la fontaine avec donnÃ©es complÃ¨tes.
              
              ğŸ’§ Niveau actuel: {{ niveau_eau }}%
              ğŸ“Š Consommation aujourd'hui: {{ consommation_jour }}ml
              âš–ï¸ Ratio hydratation: {{ ratio_hydratation }}ml/g
              ğŸ“ˆ Ã‰valuation: {{ evaluation_hydratation }}
              
              Style K-2SO (Star Wars): factuel avec lÃ©gÃ¨re touche d'humour/sarcasme.
              Inclure une rÃ©fÃ©rence geek si pertinent selon les donnÃ©es d'hydratation.
              Message bref pour TTS, max 2 phrases.
              Si ratio d'hydratation prÃ©occupant, le mentionner subtilement.
          response_variable: water_message
        - service: script.1717220445110
          data:
            message: "{{ water_message.text }}"
        - service: script.awtrix_dynamique_customapp_dupliquer
          data:
            icone: fontaine
            rainbow: "false"
            scrollspeed: "50"
            color: >
              {% if niveau_eau < 15 %}
                "#ff0000"
              {% elif niveau_eau < 25 %}
                "#ff8000"
              {% else %}
                "#ffff00"
              {% endif %}
            duree: "25"
            message: "{{ water_message.text }}"
        - delay:
            hours: 2
      while:
        - condition: or
          conditions:
            - condition: numeric_state
              entity_id: sensor.esp_pet_scales_eau
              below: 30
            - condition: state
              entity_id: sensor.validation_systeme_complet
              state: "EAU_CRITIQUE"
mode: single

# Alerte hydratation anormale
alias: "Pet Water - Alerte Hydratation Anormale"
description: "Notification si ratio d'hydratation prÃ©occupant"
triggers:
  - platform: numeric_state
    entity_id: sensor.ratio_hydratation_quotidien
    below: 1.0
    for:
      hours: 2
  - platform: numeric_state
    entity_id: sensor.ratio_hydratation_quotidien
    above: 6.0
    for:
      hours: 1
conditions:
  - condition: time
    after: "10:00:00"  # Ã‰viter fausses alertes matinales
  - condition: numeric_state
    entity_id: input_number.pet_feeder_daily_consumption_counter
    above: 5  # Assurer donnÃ©es suffisantes
actions:
  - variables:
      ratio: "{{ states('sensor.ratio_hydratation_quotidien') | float(0) }}"
      evaluation: "{{ state_attr('sensor.ratio_hydratation_quotidien', 'evaluation') }}"
      conseil: "{{ state_attr('sensor.ratio_hydratation_quotidien', 'conseil_veterinaire') }}"
  - service: google_generative_ai_conversation.generate_content
    data:
      prompt: >
        GÃ©nÃ¨re une alerte sur l'hydratation anormale dÃ©tectÃ©e.
        
        âš–ï¸ Ratio hydratation: {{ ratio }}ml/g
        ğŸ“Š Ã‰valuation: {{ evaluation }}
        ğŸ¥ Conseil: {{ conseil }}
        
        {% if ratio < 1.0 %}
        Le chat boit trÃ¨s peu par rapport Ã  ce qu'il mange. Possible dÃ©shydratation.
        {% else %}
        Le chat boit beaucoup par rapport Ã  ce qu'il mange. Surveillance recommandÃ©e.
        {% endif %}
        
        Style K-2SO mais avec une nuance de prÃ©occupation pour la santÃ©.
        SuggÃ¨re discretement une surveillance ou consultation vÃ©tÃ©rinaire si nÃ©cessaire.
    response_variable: hydration_alert
  - service: script.1717220445110
    data:
      message: "{{ hydration_alert.text }}"
  - service: persistent_notification.create
    data:
      notification_id: "pet_hydration_alert"
      title: "ğŸ©º Pet Health - Hydratation Anormale"
      message: >
        **Ratio dÃ©tectÃ©:** {{ ratio }}ml/g
        **Ã‰valuation:** {{ evaluation }}
        **Conseil:** {{ conseil }}
        
        {{ hydration_alert.text }}
mode: single
