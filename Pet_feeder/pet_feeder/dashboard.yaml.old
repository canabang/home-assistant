title: üêæ Pet Feeder
path: petfeeder
icon: mdi:food-drumstick
cards: []
type: sections
sections:
  - type: grid
    cards:
      - type: horizontal-stack
        cards:
          - type: gauge
            entity: sensor.pourcentage_croquette_restant
            name: Stock Restant
            min: 0
            max: 100
            severity:
              green: 50
              yellow: 25
              red: 10
            needle: true
          - type: custom:mini-graph-card
            entities:
              - entity: sensor.jours_restants_nourriture
                name: Jours restants
                show_state: true
                show_graph: false
            height: 80
            font_size: 75
            card_mod:
              style: |
                ha-card {
                  text-align: center;
                  {% if states('sensor.jours_restants_nourriture')|float < 3 %}
                    background: rgba(244,67,54,0.1);
                    border: 2px solid #f44336;
                  {% elif states('sensor.jours_restants_nourriture')|float < 7 %}
                    background: rgba(255,152,0,0.1);
                    border: 2px solid #ff9800;
                  {% endif %}
                }
      - type: entities
        title: üìä Suivi Consommation Avanc√©
        entities:
          - entity: sensor.consommation_moyenne_reelle
            name: Moyenne r√©elle depuis refill
            icon: mdi:chart-line-variant
            secondary_info: |
              {{ state_attr('sensor.consommation_moyenne_reelle', 'methode') }}
          - entity: input_number.pet_feeder_cumulative_distributed_since_refill
            name: Cumul√© depuis refill
            icon: mdi:scale-balance
          - entity: sensor.jours_restants_nourriture_methode_cumulative
            name: Jours restants (pr√©cis)
            icon: mdi:calendar-clock
            secondary_info: >
              {{
              state_attr('sensor.jours_restants_nourriture_methode_cumulative',
              'precision') }}
          - type: divider
          - type: custom:template-entity-row
            entity: input_number.pet_feeder_refill_date
            name: Date dernier refill
            icon: mdi:calendar-plus
            state: >
              {% set timestamp = states('input_number.pet_feeder_refill_date') |
              float(0) %} {% if timestamp > 0 %}
                {{ timestamp | timestamp_custom('%d/%m/%Y √† %H:%M') }}
              {% else %}
                Non d√©fini
              {% endif %}
            secondary: >
              {% set timestamp = states('input_number.pet_feeder_refill_date') |
              float(0) %} {% if timestamp > 0 %}
                Il y a {{ ((now().timestamp() - timestamp) / 86400) | round(1) }} jours
              {% else %}
                -
              {% endif %}
      - type: entities
        title: üìä Consommation Aujourd'hui
        entities:
          - entity: sensor.poids_reel_distribue_aujourd_hui
            name: Dernier repas
            icon: mdi:bowl
          - entity: input_number.pet_feeder_daily_consumption_counter
            name: Total consomm√© aujourd'hui
            icon: mdi:counter
          - entity: sensor.consommation_quotidienne_moyenne
            name: Moyenne quotidienne
            icon: mdi:chart-line
          - entity: input_number.pet_feeder_target_daily_weight
            name: Objectif quotidien
            icon: mdi:target
      - square: false
        type: grid
        cards:
          - type: entities
            title: üíß Statut Fontaine
            entities:
              - entity: sensor.esp_pet_scales_eau
                name: Niveau Fontaine
                secondary_info: |
                  {{ states('sensor.balance_eau_en_litres') }}L
                icon: mdi:water-percent
              - entity: sensor.consommation_eau_quotidienne
                name: Consommation Aujourd'hui
                icon: mdi:cup-water
              - entity: sensor.ratio_hydratation_quotidien
                name: Ratio Hydratation
                secondary_info: >
                  {{ state_attr('sensor.ratio_hydratation_quotidien',
                  'evaluation') }}
                icon: mdi:scale-balance
              - type: custom:bar-card
                entity: sensor.esp_pet_scales_eau
                name: Niveau Eau
                positions:
                  icon: "off"
                  name: inside
                severity:
                  - color: "#f44336"
                    from: 0
                    to: 15
                  - color: "#ff9800"
                    from: 15
                    to: 30
                  - color: "#4caf50"
                    from: 30
                    to: 100
            state_color: false
        columns: 1
        grid_options:
          columns: 12
          rows: auto
  - type: grid
    cards:
      - type: entities
        title: ‚è∞ Portions Programm√©es
        entities:
          - entity: sensor.portions_calculees_matin
            name: üåÖ Matin (8h00)
            secondary_info: >
              {{ state_attr('sensor.portions_calculees_matin',
              'poids_theorique') }} -  {{
              state_attr('sensor.portions_calculees_matin', 'pourcentage') }}
          - entity: sensor.portions_calculees_midi
            name: ‚òÄÔ∏è Midi (14h00)
            secondary_info: >
              {{ state_attr('sensor.portions_calculees_midi', 'poids_theorique')
              }} -  {{ state_attr('sensor.portions_calculees_midi',
              'pourcentage') }}
          - entity: sensor.portions_calculees_soir
            name: üåô Soir (20h00)
            secondary_info: >
              {{ state_attr('sensor.portions_calculees_soir', 'poids_theorique')
              }} -  {{ state_attr('sensor.portions_calculees_soir',
              'pourcentage') }}
          - type: divider
          - entity: sensor.total_portions_calculees
            name: üìã Total programm√©
            secondary_info: >
              {{ state_attr('sensor.total_portions_calculees',
              'poids_total_theorique') }}
      - type: horizontal-stack
        cards:
          - type: entities
            title: üì¶ Gestion Stock
            entities:
              - entity: input_number.pet_feeder_stock_estime
                name: Stock estim√©
                icon: mdi:warehouse
              - entity: input_number.pet_feeder_max_capacity
                name: Capacit√© max
                icon: mdi:barrel
              - entity: input_boolean.pet_feeder_stock_was_low
                name: Stock √©tait bas
                icon: mdi:alert-circle
              - entity: number.pet_feeder_portion_weight
                name: Poids par portion
                icon: mdi:scale
      - type: conditional
        conditions:
          - entity: sensor.esp_pet_scales_eau
            state_not: unavailable
        card:
          type: custom:mini-graph-card
          name: √âvolution Eau & Croquettes
          entities:
            - entity: sensor.esp_pet_scales_eau
              name: Eau %
              color: "#2196f3"
              y_axis: secondary
            - entity: sensor.esp_pet_scales_croquettes
              name: Croquettes %
              color: "#ff9800"
          hours_to_show: 24
          points_per_hour: 4
          line_width: 2
          show:
            graph: line
            labels: true
            legend: true
  - type: grid
    cards:
      - type: conditional
        conditions:
          - entity: sensor.consommation_quotidienne_moyenne
            state_not: "0"
        card:
          type: entities
          title: üìà Statistiques Avanc√©es
          entities:
            - type: custom:multiple-entity-row
              entity: sensor.consommation_quotidienne_moyenne
              name: Consommation aujourd'hui
              show_state: false
              entities:
                - entity: sensor.consommation_quotidienne_moyenne
                  name: Actuelle
                  unit: g
                - entity: input_number.pet_feeder_target_daily_weight
                  name: Objectif
                  unit: g
            - type: custom:multiple-entity-row
              entity: sensor.consommation_moyenne_reelle
              name: Analyse sur plusieurs jours
              show_state: false
              entities:
                - entity: sensor.consommation_moyenne_reelle
                  name: Moyenne
                  unit: g/j
                - entity: sensor.jours_restants_nourriture_methode_cumulative
                  name: Autonomie
                  unit: j
            - entity: input_number.pet_feeder_total_distributed
              name: Total distribu√© (cumul)
              icon: mdi:counter
            - type: custom:bar-card
              entity: sensor.pourcentage_croquette_restant
              name: Niveau du r√©servoir
              positions:
                icon: "off"
                name: inside
              severity:
                - color: "#f44336"
                  from: 0
                  to: 15
                - color: "#ff9800"
                  from: 15
                  to: 30
                - color: "#4caf50"
                  from: 30
                  to: 100
      - type: conditional
        conditions:
          - entity: input_number.pet_feeder_refill_date
            state_not: "0"
        card:
          type: vertical-stack
          cards:
            - type: entities
              title: üìä Comparaison Estimations
              entities:
                - entity: sensor.jours_restants_nourriture
                  name: üìä Estimation classique
                  icon: mdi:chart-bell-curve
                  secondary_info: |
                    Bas√©e sur consommation th√©orique
                - entity: sensor.jours_restants_nourriture_methode_cumulative
                  name: üéØ Calcul pr√©cis
                  icon: mdi:target
                  secondary_info: >
                    {{
                    state_attr('sensor.jours_restants_nourriture_methode_cumulative',
                    'precision') }}
                - type: custom:template-entity-row
                  entity: sensor.consommation_moyenne_reelle
                  name: Consommation r√©elle
                  icon: mdi:speedometer
                  state: "{{ states('sensor.consommation_moyenne_reelle') }} g/jour"
                  secondary: >
                    {{ state_attr('sensor.consommation_moyenne_reelle',
                    'methode') }}
            - type: gauge
              entity: sensor.consommation_moyenne_reelle
              name: Consommation R√©elle
              min: 0
              max: 120
              severity:
                green: 50
                yellow: 80
                red: 100
              needle: true
              unit: g/jour
  - type: grid
    cards:
      - type: entities
        title: üéõÔ∏è Contr√¥les
        entities:
          - type: call-service
            name: üîÑ Forcer recalcul portions
            service: homeassistant.update_entity
            service_data:
              entity_id: sensor.portions_calculees_matin
            icon: mdi:calculator
          - type: call-service
            name: üçΩÔ∏è Distribution manuelle test
            service: mqtt.publish
            service_data:
              topic: zigbee2mqtt02/Pet feeder/set
              payload: "{\"feed\": \"\"}"
            icon: mdi:play
          - type: call-service
            name: üìä Reset compteur jour
            service: input_number.set_value
            service_data:
              entity_id: input_number.pet_feeder_daily_consumption_counter
              value: 0
            icon: mdi:restore
            confirmation:
              text: √ätes-vous s√ªr de vouloir remettre le compteur √† z√©ro ?
      - type: entities
        title: üîß Gestion Manuelle
        entities:
          - entity: input_boolean.pet_feeder_manual_refill_trigger
            name: D√©clencher nouveau cycle
            icon: mdi:reload
            secondary_info: Remet √† z√©ro tous les compteurs
          - type: call-service
            name: üìù Initialiser refill manuel
            service: input_boolean.turn_on
            service_data:
              entity_id: input_boolean.pet_feeder_manual_refill_trigger
            icon: mdi:package-variant-closed
            confirmation:
              text: Cela va remettre √† z√©ro le suivi de consommation. Continuer ?
          - type: call-service
            name: üìä Mise √† jour stock estim√©
            service: input_number.set_value
            service_data:
              entity_id: input_number.pet_feeder_stock_estime
              value: "{{ states('input_number.pet_feeder_max_capacity') }}"
            icon: mdi:warehouse
            confirmation:
              text: Marquer le r√©servoir comme plein ?
      - type: entities
        title: üîç Validation Syst√®me Complet
        entities:
          - entity: sensor.validation_systeme_complet
            name: √âtat Syst√®me Global
            icon: mdi:check-decagram
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color: 
                    {% if states('sensor.validation_systeme_complet') == 'SYSTEME_OPTIMAL' %}
                      green
                    {% elif states('sensor.validation_systeme_complet') in ['EAU_FAIBLE', 'ATTENTION_CROQUETTES'] %}
                      orange
                    {% else %}
                      red
                    {% endif %} !important;
                }
          - type: custom:multiple-entity-row
            entity: sensor.validation_systeme_complet
            name: Status D√©taill√©
            show_state: false
            entities:
              - entity: sensor.validation_systeme_complet
                attribute: status_eau
                name: Eau
              - entity: sensor.validation_systeme_complet
                attribute: status_croquettes
                name: Croquettes
              - entity: sensor.validation_systeme_complet
                attribute: score_global
                name: Score
          - entity: sensor.ratio_hydratation_quotidien
            attribute: conseil_veterinaire
            name: Conseil Sant√©
            icon: mdi:medical-bag
      - type: entities
        title: üéõÔ∏è Contr√¥les Eau
        entities:
          - entity: input_number.pet_water_max_capacity
            name: Capacit√© fontaine
          - entity: input_number.pet_water_level_morning
            name: Niveau matinal sauvegard√©
          - type: call-service
            name: üíß Marquer fontaine remplie
            service: input_number.set_value
            service_data:
              entity_id: input_number.pet_water_level_morning
              value: "{{ states('sensor.esp_pet_scales_eau') }}"
            icon: mdi:water-plus
          - type: call-service
            name: üìä Reset compteur eau
            service: input_number.set_value
            service_data:
              entity_id: input_number.pet_water_daily_counter
              value: 0
            icon: mdi:restore
            confirmation:
              text: Remettre √† z√©ro le compteur d'eau ?
max_columns: 4
