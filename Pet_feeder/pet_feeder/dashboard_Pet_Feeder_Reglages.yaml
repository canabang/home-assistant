title: üîß Pet Feeder - R√©glages
path: petfeeder-settings
icon: mdi:cog
cards: []
type: sections
sections:
  - type: grid
    cards:
      - type: entities
        title: üì¶ Gestion Stock
        entities:
          - entity: input_number.pet_feeder_stock_estime
            name: Stock estim√©
            icon: mdi:warehouse
          - entity: input_number.pet_feeder_max_capacity
            name: Capacit√© max
            icon: mdi:barrel
          - entity: input_boolean.pet_feeder_stock_was_low
            name: Stock √©tait bas
            icon: mdi:alert-circle
          - entity: number.pet_feeder_portion_weight
            name: Poids par portion
            icon: mdi:scale
      - type: entities
        title: üéõÔ∏è Contr√¥les Eau
        entities:
          - entity: input_number.pet_water_max_capacity
            name: Capacit√© fontaine
            icon: mdi:water-tank
          - entity: input_number.pet_water_level_morning
            name: Niveau matinal sauvegard√©
            icon: mdi:weather-sunset-up
          - entity: input_number.pet_water_daily_counter
            name: Compteur eau quotidien
            icon: mdi:counter
  - type: grid
    cards:
      - type: entities
        title: üéõÔ∏è Contr√¥les Standards
        entities:
          - type: call-service
            name: üîÑ Forcer recalcul portions
            service: homeassistant.update_entity
            service_data:
              entity_id: sensor.portions_calculees_matin
            icon: mdi:calculator
          - type: call-service
            name: üçΩÔ∏è Distribution manuelle test
            service: mqtt.publish
            service_data:
              topic: zigbee2mqtt02/Pet feeder/set
              payload: "{\"feed\": \"\"}"
            icon: mdi:play
          - type: call-service
            name: üìä Reset compteur jour
            service: input_number.set_value
            service_data:
              entity_id: input_number.pet_feeder_daily_consumption_counter
              value: 0
            icon: mdi:restore
            confirmation:
              text: √ätes-vous s√ªr de vouloir remettre le compteur √† z√©ro ?
          - type: call-service
            name: üíß Marquer fontaine remplie
            service: input_number.set_value
            service_data:
              entity_id: input_number.pet_water_level_morning
              value: "{{ states('sensor.esp_pet_scales_eau') }}"
            icon: mdi:water-plus
          - type: call-service
            name: üìä Reset compteur eau
            service: input_number.set_value
            service_data:
              entity_id: input_number.pet_water_daily_counter
              value: 0
            icon: mdi:restore
            confirmation:
              text: Remettre √† z√©ro le compteur d'eau ?
      - type: entities
        title: üìä Contr√¥les Analytics
        entities:
          - type: call-service
            name: üîÑ Actualiser Moyennes Historiques
            service: homeassistant.update_entity
            service_data:
              entity_id:
                - sensor.consommation_moyenne_7_jours
                - sensor.consommation_moyenne_30_jours
                - sensor.tendance_consommation
            icon: mdi:refresh-circle
          - type: call-service
            name: üß† Recalculer Pr√©diction IA
            service: homeassistant.update_entity
            service_data:
              entity_id: sensor.prediction_autonomie_amelioree
            icon: mdi:brain
          - type: call-service
            name: üîç Forcer D√©tection Anomalie
            service: homeassistant.update_entity
            service_data:
              entity_id: sensor.detection_anomalie_alimentaire
            icon: mdi:magnify-scan
          - type: call-service
            name: üìã G√©n√©rer Rapport Mensuel
            service: automation.trigger
            service_data:
              entity_id: automation.pet_feeder_rapport_mensuel_automatique
            icon: mdi:file-chart-outline
            confirmation:
              text: G√©n√©rer le rapport mensuel maintenant ?
  - type: grid
    cards:
      - type: entities
        title: üîß Gestion Manuelle
        entities:
          - entity: input_boolean.pet_feeder_manual_refill_trigger
            name: D√©clencher nouveau cycle
            icon: mdi:reload
            secondary_info: Remet √† z√©ro tous les compteurs
          - type: call-service
            name: üìù Initialiser refill manuel
            service: input_boolean.turn_on
            service_data:
              entity_id: input_boolean.pet_feeder_manual_refill_trigger
            icon: mdi:package-variant-closed
            confirmation:
              text: >-
                Cela va remettre √† z√©ro le suivi de consommation ET
                l'historique. Continuer ?
          - type: call-service
            name: üìä Mise √† jour stock estim√©
            service: input_number.set_value
            service_data:
              entity_id: input_number.pet_feeder_stock_estime
              value: "{{ states('input_number.pet_feeder_max_capacity') }}"
            icon: mdi:warehouse
            confirmation:
              text: Marquer le r√©servoir comme plein ?
  - type: grid
    cards:
      - type: entities
        title: üîç Validation Syst√®me Compl√®te
        entities:
          - entity: sensor.validation_systeme_complet
            name: √âtat Syst√®me Global
            icon: mdi:check-decagram
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color: 
                    {% if states('sensor.validation_systeme_complet') == 'SYSTEME_OPTIMAL' %}
                      green
                    {% elif states('sensor.validation_systeme_complet') in ['EAU_FAIBLE', 'ATTENTION_CROQUETTES'] %}
                      orange
                    {% else %}
                      red
                    {% endif %} !important;
                }
          - type: custom:multiple-entity-row
            entity: sensor.validation_systeme_complet
            name: Status D√©taill√©
            show_state: false
            entities:
              - entity: sensor.validation_systeme_complet
                attribute: status_eau
                name: Eau
              - entity: sensor.validation_systeme_complet
                attribute: status_croquettes
                name: Croquettes
              - entity: sensor.validation_systeme_complet
                attribute: score_global
                name: Score
          - entity: sensor.detection_anomalie_alimentaire
            attribute: niveau_confiance
            name: Niveau Confiance D√©tection
            icon: mdi:shield-check-outline
          - entity: sensor.ratio_hydratation_quotidien
            attribute: conseil_veterinaire
            name: Conseil Sant√©
            icon: mdi:medical-bag
      - type: entities
        title: ‚öôÔ∏è Configuration Avanc√©e
        entities:
          - entity: input_number.pet_feeder_target_daily_weight
            name: Objectif quotidien croquettes
            icon: mdi:target
          - entity: input_number.pet_feeder_total_distributed
            name: Total distribu√© (historique)
            icon: mdi:counter
          - entity: input_number.pet_feeder_cumulative_distributed_since_refill
            name: Distribu√© depuis refill
            icon: mdi:scale-balance
          - entity: input_number.pet_feeder_daily_consumption_counter
            name: Compteur consommation quotidienne
            icon: mdi:counter
      - type: entities
        title: üìà Donn√©es de R√©f√©rence
        entities:
          - entity: sensor.consommation_quotidienne_moyenne
            name: Moyenne quotidienne
            icon: mdi:chart-line
          - entity: sensor.consommation_moyenne_reelle
            name: Moyenne r√©elle depuis refill
            icon: mdi:chart-line-variant
          - entity: sensor.consommation_moyenne_7_jours
            name: Moyenne 7 jours
            icon: mdi:chart-timeline-variant
          - entity: sensor.consommation_moyenne_30_jours
            name: Moyenne 30 jours
            icon: mdi:chart-timeline-variant
          - type: custom:template-entity-row
            entity: input_number.pet_feeder_refill_date
            name: Dernier refill
            icon: mdi:calendar-plus
            state: >
              {% set timestamp = states('input_number.pet_feeder_refill_date') |
              float(0) %} {% if timestamp > 0 %}
                {{ timestamp | timestamp_custom('%d/%m/%Y √† %H:%M') }}
              {% else %}
                Non d√©fini
              {% endif %}
  - type: grid
    cards:
      - type: entities
        title: üß™ Tests & Diagnostics
        entities:
          - type: call-service
            name: üîÑ Mise √† jour tous capteurs
            service: homeassistant.update_entity
            service_data:
              entity_id:
                - sensor.portions_calculees_matin
                - sensor.portions_calculees_midi
                - sensor.portions_calculees_soir
                - sensor.validation_systeme_complet
                - sensor.consommation_moyenne_reelle
            icon: mdi:refresh
          - type: call-service
            name: üéØ Test validation crois√©e
            service: homeassistant.update_entity
            service_data:
              entity_id: sensor.validation_stock_multi_sources
            icon: mdi:check-decagram-outline
          - type: call-service
            name: üìä Recalcul statistiques compl√®tes
            service: homeassistant.update_entity
            service_data:
              entity_id:
                - sensor.stats_mensuelles_pet_feeder
                - sensor.tendance_consommation
                - sensor.hydratation_moyenne_7_jours
                - sensor.evolution_hydratation
            icon: mdi:calculator-variant
      - type: entities
        title: üîç √âtat D√©taill√© Syst√®me
        entities:
          - entity: sensor.validation_stock_multi_sources
            name: Validation Crois√©e Sources
            icon: mdi:check-decagram-outline
            secondary_info: >
              Balance: {{ state_attr('sensor.validation_stock_multi_sources',
              'balance_pourcentage') }}% 

              | Estimation: {{
              state_attr('sensor.validation_stock_multi_sources',
              'estimation_pourcentage') }}%
          - type: custom:template-entity-row
            entity: sensor.validation_stock_multi_sources
            name: √âcart entre sources
            icon: mdi:compare-horizontal
            state: >
              {{ state_attr('sensor.validation_stock_multi_sources',
              'ecart_absolu') }}
            secondary: >
              √âcart relatif: {{
              state_attr('sensor.validation_stock_multi_sources',
              'ecart_relatif') }}
          - entity: sensor.prediction_autonomie_amelioree
            attribute: fiabilite
            name: Confiance Pr√©diction IA
            icon: mdi:brain
          - type: custom:template-entity-row
            entity: sensor.detection_anomalie_alimentaire
            name: Seuils d'Alerte Adaptatifs
            icon: mdi:alert-octagon-outline
            state: >
              {{ state_attr('sensor.detection_anomalie_alimentaire',
              'niveau_confiance') }}
            secondary: >
              Alerte si < {{ state_attr('sensor.detection_anomalie_alimentaire',
              'seuil_alerte_bas') }}g 

              ou > {{ state_attr('sensor.detection_anomalie_alimentaire',
              'seuil_alerte_haut') }}g
      - type: entities
        title: üõ†Ô∏è Maintenance Avanc√©e
        entities:
          - type: call-service
            name: üîÑ Reset complet syst√®me
            service: script.pet_feeder_reset_complet
            icon: mdi:restore-alert
            confirmation:
              text: >-
                ATTENTION: Cela va remettre √† z√©ro TOUTES les donn√©es
                historiques. √ätes-vous s√ªr ?
          - type: call-service
            name: üì§ Export donn√©es historiques
            service: script.pet_feeder_export_data
            icon: mdi:database-export
          - type: call-service
            name: üîß Calibrage balance
            service: script.pet_feeder_calibrage_balance
            icon: mdi:scale-balance
            confirmation:
              text: D√©marrer le processus de calibrage de la balance ?
          - type: call-service
            name: üßπ Nettoyage donn√©es anciennes
            service: script.pet_feeder_cleanup_old_data
            icon: mdi:delete-sweep
            confirmation:
              text: Supprimer les donn√©es de plus de 90 jours ?
max_columns: 4
