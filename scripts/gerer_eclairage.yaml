# Script Central de Gestion d'Éclairage
# Gère intelligemment l'allumage des lumières selon la source (vocal vs présence).

alias: Gérer Éclairage
description: >-
  Priorité vocale absolue. Transition douce après passage en mode jour.

fields:
  piece:
    description: Nom de la pièce (ex: chambre, cuisine, salon, sam, sdb)
    required: true
  source:
    description: "Source du déclenchement (vocal_onoff, presence, absence)"
    required: true
  action:
    description: "Action spécifique (on, off, toggle)"
    required: false

sequence:
  # Ne s'exécute que si quelqu'un est à la maison
  - condition: template
    value_template: "{{ states('sensor.etat_canabang_et_device_tracker') == 'home' }}"
  
  # INITIALISATION DES VARIABLES : Choix de la scène selon l'heure et l'historique
  - variables:
      light_entity: light.hue_{{ piece }}
      is_light_on: "{{ is_state('light.hue_' + piece, 'on') }}"
      mode_nuit: "{{ is_state('input_text.jour_nuit', 'nuit') }}"
      soleil_visible: "{{ state_attr('sun.sun', 'elevation') > 0 }}"
      
      # Logique de calcul de la scène (Veilleuse, Atténué ou Stimulation)
      scene_a_activer: >
        {% set dernier_changement_str = states('input_datetime.dernier_changement_jour_nuit') | default('1970-01-01 00:00:00') %}
        {% set maintenant_ts = as_timestamp(now()) %}
        {% if dernier_changement_str != 'unknown' and dernier_changement_str != 'unavailable' %}
          {% set dernier_changement_ts = as_timestamp(strptime(dernier_changement_str, '%Y-%m-%d %H:%M:%S')) %}
          {% set delta_minutes = ((maintenant_ts - dernier_changement_ts) / 60) | int %}
        {% else %}
          {% set delta_minutes = 99999 %}
        {% endif %}
        {% if mode_nuit or (not mode_nuit and delta_minutes < 15) %}
          scene.hue_{{ piece }}_1_veilleuse
        {% elif not soleil_visible %}
          scene.hue_{{ piece }}_3_attenue
        {% else %}
          scene.hue_{{ piece }}_2_stimulation
        {% endif %}

  - choose:
      # CAS 1 : COMMANDE VOCALE (Priorité maximale)
      - conditions:
          - condition: template
            value_template: "{{ source == 'vocal_onoff' }}"
        sequence:
          - choose:
              - conditions: # Action : Éteindre
                  - condition: or
                    conditions:
                      - condition: template
                        value_template: "{{ action == 'off' }}"
                      - condition: and
                        conditions:
                          - condition: template
                            value_template: "{{ action == 'toggle' and is_light_on }}"
                sequence:
                  - target:
                      entity_id: "{{ light_entity }}"
                    action: light.turn_off
              - conditions: # Action : Allumer
                  - condition: or
                    conditions:
                      - condition: template
                        value_template: "{{ action == 'on' }}"
                      - condition: and
                        conditions:
                          - condition: template
                            value_template: "{{ action == 'toggle' and not is_light_on }}"
                sequence:
                  - target:
                      entity_id: "{{ scene_a_activer }}"
                    action: scene.turn_on

      # CAS 2 : PRÉSENCE CAPTEUR (Logique avec blocages)
      - conditions:
          - condition: template
            value_template: "{{ source == 'presence' }}"
        sequence:
          - choose: # Vérification des blocages (Dodo, SdB occupée, etc.)
              - conditions:
                  - condition: template
                    value_template: "{{ piece == 'chambre' }}"
                  - condition: or
                    conditions:
                      - condition: template
                        value_template: "{{ mode_nuit }}"
                      - condition: state
                        entity_id: binary_sensor.esp_bed_occupation_master_bed_occupied
                        state: "on"
                sequence:
                  - stop: "Chambre bloquée"
              - conditions:
                  - condition: template
                    value_template: "{{ piece == 'sdb' }}"
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: switch.prismal
                        state: "on"
                      - condition: numeric_state
                        entity_id: sensor.lux_sdb
                        above: 2
                sequence:
                  - stop: "SDB bloquée"
          # Activation de la scène si pas déjà allumée ou mauvaise scène
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ not is_light_on }}"
                sequence:
                  - target:
                      entity_id: "{{ scene_a_activer }}"
                    action: scene.turn_on

      # CAS 3 : ABSENCE DÉTECTÉE (Éteindre)
      - conditions:
          - condition: template
            value_template: "{{ source == 'absence' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_light_on }}"
                sequence:
                  - target:
                      entity_id: "{{ light_entity }}"
                    action: light.turn_off
mode: parallel
