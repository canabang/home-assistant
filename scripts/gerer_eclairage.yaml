# ==========================================================
# SCRIPT CENTRAL DE GESTION D’ÉCLAIRAGE
# ==========================================================
# Ce script est l'intelligence centrale qui pilote toutes les lumières Hue.
# Il est conçu pour être appelé par :
#   1. Les Intents Vocaux (Phase 1 & 2) -> source: vocal_onoff
#   2. Les Automatisations de présence  -> source: presence / absence
# ==========================================================

alias: Gérer Éclairage
description: >-
  Gère l'éclairage intelligemment : Priorité vocale, calcul de scène dynamique 
  (jour/nuit/réveil) et gestion des blocages (lit occupé, SdB, etc).

# FIELDS : Définition des paramètres d'entrée
fields:
  piece:
    description: "Le nom de la pièce cible (ex: chambre, salon, cuisine, sdb)"
    example: chambre
    required: true
  source:
    description: "D'où vient l'appel (vocal_onoff, presence, absence)"
    example: vocal_onoff
    required: true
  action:
    description: "L'ordre spécifique pour le vocal (on, off, toggle)"
    example: "on"
    required: false

sequence:
  # ÉTAPE 0 : Condition de sécurité
  # On ne lance rien si personne n'est considéré comme étant à la maison.
  - condition: template
    value_template: "{{ states('sensor.etat_canabang_et_device_tracker') == 'home' }}"
  
  # ÉTAPE 1 : Préparation des variables
  # VARIABLE : On calcule ici tout ce qui servira à prendre une décision.
  - variables:
      light_entity: light.hue_{{ piece }}
      is_light_on: "{{ is_state('light.hue_' + piece, 'on') }}"
      mode_nuit: "{{ is_state('input_text.jour_nuit', 'nuit') }}"
      soleil_visible: "{{ state_attr('sun.sun', 'elevation') > 0 }}"
      
      # LOGIQUE : CALCUL DE LA SCÈNE IDÉALE
      scene_a_activer: >
        {% set dernier_changement_str = states('input_datetime.dernier_changement_jour_nuit') | default('1970-01-01 00:00:00') %}
        {% set maintenant_ts = as_timestamp(now()) %}
        {% if dernier_changement_str != 'unknown' and dernier_changement_str != 'unavailable' %}
          {% set dernier_changement_ts = as_timestamp(strptime(dernier_changement_str, '%Y-%m-%d %H:%M:%S')) %}
          {% set delta_minutes = ((maintenant_ts - dernier_changement_ts) / 60) | int %}
        {% else %}
          {% set delta_minutes = 99999 %}
        {% endif %}

        {# CHOIX FINAL : #}
        {% if mode_nuit or (not mode_nuit and delta_minutes < 15) %}
          scene.hue_{{ piece }}_1_veilleuse
        {% elif not soleil_visible %}
          scene.hue_{{ piece }}_3_attenue
        {% else %}
          scene.hue_{{ piece }}_2_stimulation
        {% endif %}

  # ÉTAPE 2 : Branchement par SOURCE
  - choose:
      # ------------------------------------------------------------------
      # CAS A : COMMANDE VOCALE (L'utilisateur a parlé)
      # ------------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: "{{ source == 'vocal_onoff' }}"
        sequence:
          - choose:
              # DATA : Allumer ou Éteindre selon l'action demandée
              - conditions:
                  - condition: or
                    conditions:
                      - condition: template
                        value_template: "{{ action == 'off' }}"
                      - condition: and
                        conditions:
                          - condition: template
                            value_template: "{{ action == 'toggle' and is_light_on }}"
                sequence:
                  - target:
                      entity_id: "{{ light_entity }}"
                    action: light.turn_off
              
              - conditions:
                  - condition: or
                    conditions:
                      - condition: template
                        value_template: "{{ action == 'on' }}"
                      - condition: and
                        conditions:
                          - condition: template
                            value_template: "{{ action == 'toggle' and not is_light_on }}"
                sequence:
                  - target:
                      entity_id: "{{ scene_a_activer }}"
                    action: scene.turn_on

      # ------------------------------------------------------------------
      # CAS B : PRÉSENCE CAPTEUR (Détection de mouvement)
      # ------------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: "{{ source == 'presence' }}"
        sequence:
          - choose:
              # LOGIQUE DE BLOCAGE :
              - conditions:
                  - condition: template
                    value_template: "{{ piece == 'chambre' }}"
                  - condition: or
                    conditions:
                      - condition: template
                        value_template: "{{ mode_nuit }}"
                      - condition: state
                        entity_id: binary_sensor.esp_bed_occupation_master_bed_occupied
                        state: "on"
                sequence:
                  - stop: "Arrêt : Chambre occupée/repos."
              
              - conditions:
                  - condition: template
                    value_template: "{{ piece == 'sdb' }}"
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: switch.prismal
                        state: "on"
                      - condition: numeric_state
                        entity_id: sensor.lux_sdb
                        above: 2
                sequence:
                  - stop: "Arrêt : SdB déjà éclairée/occupée."
          
          # Si pas de blocage : On allume
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ not is_light_on }}"
                sequence:
                  - target:
                      entity_id: "{{ scene_a_activer }}"
                    action: scene.turn_on

      # ------------------------------------------------------------------
      # CAS C : ABSENCE DÉTECTÉE (Plus de mouvement)
      # ------------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: "{{ source == 'absence' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_light_on }}"
                sequence:
                  - target:
                      entity_id: "{{ light_entity }}"
                    action: light.turn_off

mode: parallel
