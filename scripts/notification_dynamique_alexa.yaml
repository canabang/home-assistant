# Script de Notification Dynamique Alexa
# Ce script permet de parler sur les enceintes Echo sans couper brutalement la musique.

alias: notification alexa
sequence:
  - choose:
      - conditions:
          # On ne parle que si la personne est à la maison et qu'il fait jour
          - condition: state
            entity_id: person.canabang
            state: home
          - condition: state
            state: jour
            entity_id: input_text.jour_nuit
        sequence:
          # GESTION MUSIQUE : Pause Spotify si nécessaire
          - choose:
              - conditions:
                  - condition: state
                    state: playing
                    entity_id: media_player.spotifyplus_gael
                sequence:
                  - action: media_player.media_play_pause
                    target:
                      entity_id: media_player.spotifyplus_gael
                  - action: input_boolean.turn_on
                    target:
                      entity_id: input_boolean.pause_musique
          
          # PARAMÈTRES : Définition du volume et de l'enceinte cible
          - variables:
              echo: "{{ state_attr('sensor.presence_piece', 'echo') }}"
              volume_precedent: "{{ state_attr( echo , 'volume_level') }}"
              duree_message: "{{ ((message | length / 12) + 3) | round(0) }}"
          
          # ACTION : Baisse le son, parle, puis remonte le son
          - action: media_player.volume_set
            target:
              entity_id: "{{ echo }}"
            data:
              volume_level: 0.3
          - action: notify.alexa_media
            data:
              message: "{{ message }}"
              data:
                type: tts
              target: "{{ echo }}"
          - delay:
              seconds: "{{ duree_message | int }}"
          - action: media_player.volume_set
            target:
              entity_id: "{{ echo }}"
            data:
              volume_level: "{{ volume_precedent }}"
          
          # REPRISE MUSIQUE : Relance Spotify si on l'avait coupé
          - choose:
              - conditions:
                  - condition: state
                    entity_id: input_boolean.pause_musique
                    state: "on"
                sequence:
                  - action: input_boolean.turn_off
                    target:
                      entity_id: input_boolean.pause_musique
                  - action: media_player.media_play_pause
                    target:
                      entity_id: media_player.spotifyplus_gael

mode: queued
fields:
  message:
    selector:
      text: {}
    name: message
    description: Le message que K-2SO doit prononcer
    required: true
max: 10
