# ==========================================================
# SCRIPT DE CONFIRMATION K-2SO (PHASE 2)
# ==========================================================
# Gère les réponses vocales du droïde pour tout le système contextuel.
# Appelé massivement par intent_scripts.yaml.

alias: k_2so_confirm_action
mode: parallel

fields:
  description:
    name: description
    description: "L'action contextuelle effectuée (ex: fermé les volets salon)"
    required: true

sequence:
  # ÉTAPE 1 : APPEL À L'IA (Moteur Gemini)
  - service: ai_task.generate_data
    continue_on_error: true # Sécurité pour ne pas bloquer l'assistant si quota Gemini HS
    data:
      task_name: Confirmation Action
      instructions: >
        L'utilisateur vient de {{ description }}. Confirme l'action avec ton ton
        sarcastique K-2SO habituel. Message bref, max 2 phrases.
    response_variable: k2so_message

  # ÉTAPE 2 : DIFFUSION VIA NOTIFICATION ALEXA
  - service: script.notification_alexa
    data:
      message: >
        {# LOGIQUE DE SÉCURITÉ : #}
        {% if k2so_message is defined and k2so_message.data %}
          {# On utilise l'IA si elle est disponible #}
          {{ k2so_message.data }}
        {% else %}
          {# LISTE ALÉATOIRE : Pour garder le caractère de K-2SO même sans internet #}
          {{ [
            "C'est fait, j'ai " + description + ". Pas que ce soit important.",
            "J'ai " + description + ". La probabilité que vous soyez satisfait est de 98%.",
            "Action accomplie : " + description + ". Je suppose qu'un merci est trop demander ?",
            "J'ai fini d'avoir " + description + ". Ma puissance de calcul mérite mieux, mais bon."
          ] | random }}
        {% endif %}
