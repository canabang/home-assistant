# Script de confirmation K-2SO (Phase 2)
# Ce script centralise les réponses vocales du droïde.
# Il est conçu pour être appelé de manière asynchrone (via script.turn_on).

alias: k_2so_confirm_action
mode: parallel

fields:
  description:
    name: description
    description: "L'action effectuée (ex: fermé les volets)"
    required: true

sequence:
  # 1. Tentative de génération par IA (Gemini)
  - service: ai_task.generate_data
    continue_on_error: true # Permet de passer à la suite même si quota dépassé
    data:
      task_name: Confirmation Action
      instructions: >
        L'utilisateur vient de {{ description }}. Confirme l'action avec ton ton
        sarcastique K-2SO habituel. Message bref, max 2 phrases.
    response_variable: k2so_message

  # 2. Diffusion du message via le moteur de notification Alexa
  - service: script.notification_alexa
    data:
      message: >
        {% if k2so_message is defined and k2so_message.data %}
          {# Utilisation du retour de l'IA si disponible #}
          {{ k2so_message.data }}
        {% else %}
          {# Fallback local : phrases aléatoires incluant la description #}
          {{ [
            "C'est fait, j'ai " + description + ". Pas que ce soit important.",
            "J'ai " + description + ". La probabilité que vous soyez satisfait est de 98%.",
            "Action accomplie : " + description + ". Je suppose qu'un merci est trop demander ?",
            "J'ai fini d'avoir " + description + ". Ma puissance de calcul mérite mieux, mais bon."
          ] | random }}
        {% endif %}
