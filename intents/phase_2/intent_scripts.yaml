# Logique principale du système K-2SO (Phase 2)
# Gère la détection de la pièce et l'exécution des ordres.

TurnOnContextualLight:
  action:
    - service: script.gerer_eclairage
      data:
        # Simplification : On utilise uniquement le capteur de présence réelle
        piece: "{{ states('sensor.presence_piece') | lower }}"
        source: "vocal_onoff"
        action: "on"
    - service: script.turn_on
      target:
        entity_id: script.k_2so_confirm_action
      data:
        variables:
          description: "allumé la lumière {{ piece }}"

TurnOffContextualLight:
  action:
    - service: script.gerer_eclairage
      data:
        piece: "{{ states('sensor.presence_piece') | lower }}"
        source: "vocal_onoff"
        action: "off"
    - service: script.turn_on
      target:
        entity_id: script.k_2so_confirm_action
      data:
        variables:
          description: "éteint la lumière {{ piece }}"

TurnOnContextualCover:
  action:
    - service: cover.open_cover
      target:
        entity_id: >
          {% set piece = states('sensor.presence_piece') | lower %}
          cover.vol{{ piece }}
    - service: script.turn_on
      target:
        entity_id: script.k_2so_confirm_action
      data:
        variables:
          description: "ouvert le volets {{ piece }}"

TurnOffContextualCover:
  action:
    - service: cover.close_cover
      target:
        entity_id: >
          {% set piece = states('sensor.presence_piece') | lower %}
          cover.vol{{ piece }}
    - service: script.turn_on
      target:
        entity_id: script.k_2so_confirm_action
      data:
        variables:
          description: "fermé le volets {{ piece }}"

# Intent technique pour vérifier ce que HA voit réellement
DiagnosticIntent:
  action:
    - service: script.notification_alexa
      data:
        message: >
          Diagnostic final : 
          Presence: {{ states('sensor.presence_piece') | default('aucun') }}.

StartCoffee:
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.priscafe # Entity ID à vérifier
    - service: script.turn_on
      target:
        entity_id: script.k_2so_confirm_action
      data:
        variables:
          description: "lancé le café"

GoToSleep:
  action:
    - service: automation.trigger
      target:
        entity_id: automation.mode_dodo_2 # Entity ID à vérifier
    - service: script.turn_on
      target:
        entity_id: script.k_2so_confirm_action
      data:
        variables:
          description: "activé le mode dodo"
