# ==========================================================
# SCRIPT DE CONFIRMATION K-2SO (PHASE 1)
# ==========================================================
# Ce script génère une réponse vocale pleine de caractère après une action.
# Il est conçu pour être lancé en tâche de fond (asynchrone).

alias: k_2so_confirm_action
mode: parallel

# CHAMPS : On définit les données attendues par le script
fields:
  description:
    name: description
    description: "L'action qui vient d'être faite (ex: allumé le salon)"
    required: true

sequence:
  # ÉTAPE 1 : GÉNÉRATION IA (Priorité)
  # On demande à Google Gemini de nous pondre une phrase sarcastique.
  - service: ai_task.generate_data
    continue_on_error: true # INDISPENSABLE : permet de continuer si l'IA échoue
    data:
      task_name: Confirmation Action
      instructions: >
        L'utilisateur vient de {{ description }}. Confirme l'action avec ton ton
        sarcastique K-2SO habituel. Message bref, max 2 phrases.
    response_variable: k2so_message

  # ÉTAPE 2 : DIFFUSION VOCALE
  # On envoie le texte final au script de notification Alexa.
  - service: script.notification_alexa
    data:
      message: >
        {# LOGIQUE DE CHOIX DU MESSAGE : #}
        {% if k2so_message is defined and k2so_message.data %}
          {# 2.1 : Si l'IA a répondu, on utilise son texte #}
          {{ k2so_message.data }}
        {% else %}
          {# 2.2 : SI l'IA est hors-ligne ou quota dépassé, on utilise une liste de secours #}
          {# Le filtre '| random' choisit une phrase au hasard pour varier les plaisirs #}
          {{ [
            "C'est fait, j'ai " + description + ". Pas que ce soit important.",
            "J'ai " + description + ". La probabilité que vous soyez satisfait est de 98%.",
            "Action accomplie : " + description + ". Je suppose qu'un merci est trop demander ?",
            "J'ai fini d'avoir " + description + ". Ma puissance de calcul mérite mieux, mais bon."
          ] | random }}
        {% endif %}
