alias: ğŸ¤– Frigate â†’ Discord + HA (Smart Notif)
description: DÃ©tections Frigate avec GenAI, identification auto, emojis et cooldown

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DÃ‰CLENCHEUR : Ã‰coute les Ã©vÃ©nements MQTT publiÃ©s par Frigate
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
triggers:
  # Topic MQTT oÃ¹ Frigate publie tous ses Ã©vÃ©nements de dÃ©tection
  - topic: frigate/events
    trigger: mqtt

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONDITIONS : Filtres pour Ã©viter les notifications inutiles
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
conditions:
  # Condition 1 : Ne notifier QUE quand l'Ã©vÃ©nement est terminÃ© et a un snapshot
  # (Ã©vite les notifications pendant le tracking)
  - condition: template
    value_template: >
      {{ trigger.payload_json.type == 'end' and
         trigger.payload_json.after.has_snapshot }}
  
  # Condition 2 : COOLDOWN pour Ã©viter le spam de notifications
  # âš™ï¸ MODIFIE LES DURÃ‰ES ICI âš™ï¸
  # Utilise les helpers input_datetime crÃ©Ã©s (voir instructions ci-dessous)
  - condition: template
    value_template: >
      {% set label = trigger.payload_json.after.label %}
      {% set now_ts = now() %}
      {% if label == 'cat' %}
        {# â±ï¸ COOLDOWN CHAT : 30 minutes #}
        {# Pour changer : modifie le chiffre 30 ci-dessous #}
        {# Exemples : 10, 20, 60 (en minutes) #}
        {% set last_notif = states('input_datetime.frigate_derniere_notif_chat') %}
        {{ last_notif == 'unknown' or (now_ts - strptime(last_notif, '%Y-%m-%d %H:%M:%S')).total_seconds() > 1800 }}
      {% elif label == 'person' %}
        {# â±ï¸ COOLDOWN PERSONNE : 5 minutes #}
        {# Pour changer : modifie le chiffre 5 ci-dessous (converti en secondes : 5*60=300) #}
        {# Exemples : 1, 3, 10 (en minutes) #}
        {% set last_notif = states('input_datetime.frigate_derniere_notif_personne') %}
        {{ last_notif == 'unknown' or (now_ts - strptime(last_notif, '%Y-%m-%d %H:%M:%S')).total_seconds() > 300 }}
      {% else %}
        {# Autres dÃ©tections (si tu ajoutes d'autres objets) : pas de cooldown #}
        true
      {% endif %}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ACTIONS : Ce qui se passe quand les conditions sont remplies
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
actions:
  # Action 1 : Mettre Ã  jour le timestamp de la derniÃ¨re notification (pour le cooldown)
  # Enregistre l'heure actuelle dans le helper input_datetime correspondant
  - choose:
      # Si c'est un chat, met Ã  jour input_datetime.frigate_derniere_notif_chat
      - conditions:
          - condition: template
            value_template: "{{ label == 'cat' }}"
        sequence:
          - service: input_datetime.set_datetime
            target:
              entity_id: input_datetime.frigate_derniere_notif_chat
            data:
              datetime: "{{ now() }}"
      # Si c'est une personne, met Ã  jour input_datetime.frigate_derniere_notif_personne
      - conditions:
          - condition: template
            value_template: "{{ label == 'person' }}"
        sequence:
          - service: input_datetime.set_datetime
            target:
              entity_id: input_datetime.frigate_derniere_notif_personne
            data:
              datetime: "{{ now() }}"
  
  # Action 2 : Envoyer la notification Discord via ton script existant
  - action: script.notification_discord
    data:
      # Nom avec emoji : "ğŸ± Princesse" ou "ğŸ  GaÃ«l"
      nom: "{{ emoji }} {{ identity_name }}"
      # Description formatÃ©e avec toutes les infos
      description: |
        {{ emoji }} **{{ identity_name }}** dÃ©tectÃ©{{ 'e' if label == 'cat' else '' }}
        ğŸ“· **CamÃ©ra:** {{ camera_name }}
        â° **Heure:** {{ timestamp }}
        ğŸ¯ **Score:** {{ score }}%
        
        **ğŸ¤– Rapport K-2SO:**
        {{ description }}
        
        [ğŸ“¹ Voir la vidÃ©o]({{ clip_url }}) â€¢ [ğŸ“Š DÃ©tails]({{ details_url }})
      # URL de l'image snapshot
      image_url: "{{ snapshot_url }}"
      images: "{{ snapshot_url }}"
  
  # Action 3 : CrÃ©er une notification persistante dans Home Assistant
  # (visible dans la barre de notification jusqu'Ã  ce qu'on la ferme)
  - action: persistent_notification.create
    data:
      # ID unique basÃ© sur l'event Frigate (permet de remplacer si doublon)
      notification_id: "frigate_{{ event_id }}"
      # Titre court avec emoji
      title: "{{ emoji }} {{ identity_name }} - {{ camera_name }}"
      # Message dÃ©taillÃ© avec Markdown
      message: >
        â° **{{ timestamp }}**
        
        **ğŸ¤– Rapport K-2SO:**
        {{ description }}
        
        **DÃ©tails techniques:**
        â€¢ Label: {{ label }}
        â€¢ Score: {{ score }}%
        â€¢ DurÃ©e: {{ duration }}s
        â€¢ Event ID: `{{ event_id }}`
        
        **Liens:**
        [ğŸ“¸ Snapshot]({{ snapshot_url }}) â€¢ [ğŸ“¹ VidÃ©o]({{ clip_url }}) â€¢ [ğŸ“Š DÃ©tails]({{ details_url }})

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MODE & LIMITE : Gestion des notifications simultanÃ©es
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
mode: queued  # Les notifications sont mises en file d'attente (pas de perte)
max: 10       # Maximum 10 notifications en attente

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VARIABLES : Extraction et traitement des donnÃ©es de l'Ã©vÃ©nement
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
variables:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # DonnÃ©es brutes extraites du payload MQTT de Frigate
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  event_id: "{{ trigger.payload_json.after.id }}"
  camera: "{{ trigger.payload_json.after.camera }}"
  label: "{{ trigger.payload_json.after.label }}"  # "cat", "person", etc.
  score: "{{ (trigger.payload_json.after.score * 100) | round(0) }}"  # Score de confiance en %
  sub_label: "{{ trigger.payload_json.after.sub_label | default('') }}"  # Nom reconnu (GaÃ«l, etc.) ou vide
  duration: "{{ trigger.payload_json.after.end_time - trigger.payload_json.after.start_time }}"  # DurÃ©e en secondes
  description: "{{ trigger.payload_json.after.attributes.genai.description | default('Description non disponible') }}"  # Description GenAI/K-2SO
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Nom de la camÃ©ra traduit en franÃ§ais avec emoji
  # âš™ï¸ AJOUTE TES CAMÃ‰RAS ICI âš™ï¸
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  camera_name: >
    {% if camera == 'holocron' %}
      ğŸ½ï¸ Gamelles
    {% elif camera == 'oeil-de-sauron' %}
      ğŸšª EntrÃ©e
    {% else %}
      {{ camera }}  # Nom brut si camÃ©ra non reconnue
    {% endif %}
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Emoji basÃ© sur le type de dÃ©tection ET reconnaissance faciale
  # âš™ï¸ PERSONNALISE LES EMOJIS ICI âš™ï¸
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  emoji: >
    {% if label == 'cat' %}
      ğŸ±  {# Toujours un chat pour Princesse #}
    {% elif label == 'person' %}
      {% if sub_label and sub_label != 'unknown' %}
        ğŸ   {# Personne reconnue (GaÃ«l, etc.) #}
      {% else %}
        âš ï¸  {# Personne inconnue/non reconnue #}
      {% endif %}
    {% else %}
      ğŸ”  {# Autre type de dÃ©tection #}
    {% endif %}
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Nom identifiÃ© de maniÃ¨re intelligente
  # Utilise la reconnaissance faciale de Frigate via sub_label
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  identity_name: >
    {% if label == 'cat' %}
      Princesse
    {% elif label == 'person' %}
      {% if sub_label and sub_label != 'unknown' %}
        {{ sub_label }}  {# Nom reconnu par Frigate (ex: "GaÃ«l") #}
      {% else %}
        Personne inconnue
      {% endif %}
    {% else %}
      DÃ©tection {{ label }}  {# Pour tout autre type d'objet #}
    {% endif %}
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Horodatage formatÃ© en franÃ§ais
  # Format : 21/11/25 Ã  07h28
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  timestamp: "{{ now().strftime('%d/%m/%y Ã  %Hh%M') }}"
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # URLs pour accÃ©der aux mÃ©dias et dÃ©tails de l'Ã©vÃ©nement
  # âš™ï¸ REMPLACE PAR TON URL FRIGATE âš™ï¸
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  snapshot_url: "https://frigate.canagalactica.ovh/api/events/{{ event_id }}/snapshot.jpg"
  clip_url: "https://frigate.canagalactica.ovh/api/events/{{ event_id }}/clip.mp4"
  details_url: "https://frigate.canagalactica.ovh/events?camera={{ camera }}&id={{ event_id }}"
