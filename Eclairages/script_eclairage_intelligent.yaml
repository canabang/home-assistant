alias: Éclairage Intelligent Multi-Pièces
description: Script centralisé pour gérer l'éclairage selon les conditions communes
fields:
  piece:
    selector:
      text: null
    name: piece
    description: Nom de la pièce (utiliser {{ trigger.id }})
    example: chambre
    required: true
    default: " {{ trigger.id }}"
sequence:
  - variables:
      light_entity: light.hue_{{ piece }}
  - condition: and
    conditions:
      - condition: state
        entity_id: sensor.etat_canabang_et_device_tracker
        state: home
      - condition: template
        value_template: "{{ states(light_entity) == 'off' }}"
        alias: Si lumiere == off
  - choose:
      - conditions:
          - condition: or
            conditions:
              - condition: state
                entity_id: input_text.jour_nuit
                state: nuit
              - condition: template
                value_template: >
                  {% set dernier_changement =
                  states('input_datetime.dernier_changement_jour_nuit') %} {% if
                  dernier_changement not in ['unknown', 'unavailable'] %}
                    {% set changement_datetime = as_timestamp(dernier_changement) %}
                    {% set current_timestamp = now().timestamp() %}
                    {% set diff_seconds = current_timestamp - changement_datetime %}
                    {{ diff_seconds < 1200 and states('input_text.jour_nuit') == 'jour' }}
                  {% else %}
                    false
                  {% endif %}
            alias: si nuit ou jour < 20mn
        sequence:
          - target:
              entity_id: scene.hue_{{ piece }}_1_veilleuse
            action: scene.turn_on
            data: {}
      - conditions:
          - condition: state
            entity_id: input_text.jour_nuit
            state: jour
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: sun.sun
                    state: above_horizon
                sequence:
                  - target:
                      entity_id: scene.hue_{{ piece }}_2_stimulation
                    action: scene.turn_on
                    data: {}
              - conditions:
                  - condition: state
                    entity_id: sun.sun
                    state: below_horizon
                sequence:
                  - target:
                      entity_id: scene.hue_{{ piece }}_3_attenue
                    action: scene.turn_on
                    data: {}
mode: single
