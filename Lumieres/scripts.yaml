# SCRIPT POUR APPLIQUER LES SCENES SELON LE CONTEXTE
# ===================================================

script:
  appliquer_scene_lumiere:
    alias: "Appliquer Scène Lumière Contextuelle"
    description: "Applique la bonne scène selon le mode jour/nuit et le contexte"
    fields:
      piece:
        description: "Nom de la pièce (cuisine, salon, sam, chambre, sdb)"
        example: "cuisine"
      force_veilleuse:
        description: "Forcer la veilleuse même en mode jour (optionnel)"
        default: false
    sequence:
      - choose:
          # Mode nuit ou veilleuse forcée
          - conditions:
              - condition: or
                conditions:
                  - condition: state
                    entity_id: input_text.jour_nuit
                    state: "nuit"
                  - condition: template
                    value_template: "{{ force_veilleuse | default(false) }}"
            sequence:
              - service: scene.turn_on
                target:
                  entity_id: "scene.hue_{{ piece }}_1_veilleuse"
          # Mode jour avec conditions pour atténué
          - conditions:
              - condition: state
                entity_id: input_text.jour_nuit
                state: "jour"
              - condition: or
                conditions:
                  - condition: template
                    value_template: >
                      {% set dernier_changement = as_timestamp(states('input_datetime.dernier_changement_jour_nuit')) %}
                      {% set maintenant = as_timestamp(now()) %}
                      {{ (maintenant - dernier_changement) < 1200 }}
                  - condition: state
                    entity_id: sun.sun
                    state: "below_horizon"
            sequence:
              - service: scene.turn_on
                target:
                  entity_id: "scene.hue_{{ piece }}_3_attenue"
        # Par défaut : stimulation
        default:
          - service: scene.turn_on
            target:
              entity_id: "scene.hue_{{ piece }}_2_stimulation"
